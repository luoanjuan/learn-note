
# Redis

## Redis 持久化
#### 内存快照RDB文件
Redis服务启动时，用户可以通过指定的配置文件或者传入的启动参数的方式设置save选择。Redis的服务器周期性操作函数serverCron默认执行一次，该函数用于对正在运行的服务器进行维护、
，一项工作就是对save选项进行检查，如果满足就执行BGSAVE命令。
#### AOP文件
写入和刷盘策略appendfsync：（和InnoDB重做日志的同步策略选项完全相同）
always：将aof_buf内容写到AOF文件，同时同步到磁盘
everysec：aof_buf内容写入到AOF文件，每一秒同步到磁盘
no：aof_buf内容写入到AOF文件，同步由操作系统去控制
AOP重写：子进程重写，不阻塞。设置AOP重写缓冲区：这时客户端写会执行三步：执行客户端命令；将执行的命令写到AOF缓冲区；将执行的命令追加到AOF重写缓冲区。
当子进程完成AOF重写工作，会给父进程发送一个信号，父进程会调用一个信号处理函数（调用信号处理函数期间会阻塞），执行下面工作：
- 将AOF重写缓冲区中的所有内容写入到新的AOF文件中
- 对新的AOF文件进行更名，原子的覆盖先用的AOF文件。

### 内存淘汰策略
- noeviction：当内存不足以容纳新写入数据时，新写入操作会报错，这个一般没人用吧
- allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的key（这个是最常用的）
- allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个key，这个一般没人用吧
- volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的key（这个一般不太合适）
- volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个key
- volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的key优先移除  

每个Redis对象都会有一个lru属性，保存了对象最后已给被命令访问的时间。

## 事件
Redis服务器是一个事件驱动程序：
- 文件事件：Redis服务器通过套接字与客户端进行连接，而文件事件就是服务器对套接字操作的抽象。
- 时间事件：Redis服务器中一些操作需要在给定的时间点执行，而时间事件就是对这类定时操作的抽象。

### 文件事件
Redis基于Reactor模式开发了自己的网络事件处理器：文件事件处理器使用I/O多路复用程序来监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器。

文件事件处理器的四个组成部分：套接字、I/O多路复用程序、文件事件分派器、事件处理器。尽管多个文件事件可能会并发出现，但是I/O多路复用程序总是会将所有产生事件的套接字都放到一个队列里面，
以有序的、同步、没诚意一个套接字的方式向文件事件分派器传送套接字。文件事件分派器根据套接字中的事件类型，调用相应的事件处理器。

## 多机数据库
复制、哨兵、集群
### 复制
可以通过SLAVEOF命令或者设置slaveof选项，让一个服务器去复制一个服务器。
- 同步：将主服务器上的数据状态更新到从服务器上
    - 从服务器向主服务器发送SYNC命令
    - 主服务器收到SYNC命令后生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令
    - 主服务器执行完BGSAVE命令后，将生成的RDB文件发送给从服务器。从服务器载入RDB文件。
    - 主服务将记录在缓冲区里面的所有写命令发送给从服务器
- 命令传播：主服务器将自己接收到的写命令发送给从服务器

早期版本的复制，如果从服务器断线重连后需要重新全部同步，比较低效。

新版本可以实现部分同步， 部分同步实现的原理：
- 复制偏移量：主从服务器上分别维护一个复制偏移量
    - 主服务器每次向从服务器传播N个自己数据时，就将自己的复制偏移量的值加N
    - 从服务器每次接收到N个字节的数据时，将自己的复制偏移量加N
- 复制积压缓冲区：复制积压缓冲区是主服务器维护的一个固定长度的先进先出的队列，默认大小为1MB。主服务器命令传播时候还会将写命令入队到复制积压缓冲区里面。就是说复制积压缓冲区里面
保存这一部分最近传播的写命令，并且复制积压缓冲区还会记录每个字节相应的复制偏移量。
- 服务器运行的ID：运行ID是服务器启动时候自动生成的。从服务器初次复制的时候，主服务器会将自己运行ID传送给从服务器。重连的时候从服务器会将这个ID传给主服务器，如果主服务器ID是这个，
才会去检查复制积压缓冲区是否包含了从服务器offset以后的写命令，如果不一致就走初次复制流程。 